# Test Design: Story 1.3

Date: 2025-01-27
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 66
- **Unit tests**: 13 (20%)
- **Integration tests**: 49 (74%)
- **E2E tests**: 4 (6%)
- **Priority distribution**: P0: 28, P1: 24, P2: 14

**Test Strategy Rationale**: Database setup is foundational infrastructure requiring comprehensive integration testing. Unit tests focus on model validation and configuration logic. Integration tests verify database operations, migrations, and connection management. E2E tests validate critical database connection paths from application startup.

## Test Scenarios by Acceptance Criteria

### AC1: PostgreSQL database is accessible via Docker Compose (local development) or Railway managed Postgres (production)

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-INT-001 | Integration | P0 | Verify PostgreSQL service starts in Docker Compose | Validates infrastructure setup | OPS-002 |
| 1.3-INT-002 | Integration | P0 | Verify database connection from backend container | Validates container networking | TECH-001, OPS-002 |
| 1.3-INT-003 | Integration | P1 | Verify database connection with Railway Postgres format | Validates production compatibility | TECH-001 |
| 1.3-INT-004 | Integration | P1 | Verify database health check endpoint works | Validates monitoring capability | OPS-003 |
| 1.3-INT-057 | Integration | P0 | Verify SSL/TLS connection is enforced in production environment | Validates encryption requirement | SEC-004 |
| 1.3-INT-058 | Integration | P0 | Verify SSL certificate validation works correctly | Validates certificate verification | SEC-004 |
| 1.3-INT-059 | Integration | P1 | Verify connection fails gracefully if SSL required but unavailable | Validates SSL enforcement | SEC-004 |
| 1.3-E2E-001 | E2E | P0 | Verify full stack database connection (frontend → backend → database) | Validates end-to-end connectivity | TECH-001, OPS-002 |

**Coverage**: All scenarios test database accessibility from different perspectives (infrastructure, container, production format, monitoring, full stack).

---

### AC2: SQLAlchemy 2.0 is configured with asyncpg driver and AsyncSession

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-UNIT-001 | Unit | P0 | Verify SQLAlchemy 2.0 version is installed | Validates dependency version | TECH-001 |
| 1.3-UNIT-002 | Unit | P0 | Verify asyncpg driver is installed | Validates async driver dependency | TECH-001 |
| 1.3-INT-005 | Integration | P0 | Verify AsyncEngine is created with asyncpg driver | Validates async engine configuration | TECH-001 |
| 1.3-INT-006 | Integration | P0 | Verify AsyncSession can be created from AsyncSessionLocal | Validates session factory pattern | TECH-001 |
| 1.3-INT-007 | Integration | P0 | Verify async database query executes successfully | Validates async/await pattern works | TECH-001 |
| 1.3-INT-008 | Integration | P0 | Verify AsyncSession properly closes after use | Validates session cleanup | TECH-001, TECH-003 |
| 1.3-INT-009 | Integration | P1 | Verify async transaction commit works | Validates async transaction handling | TECH-001 |
| 1.3-INT-010 | Integration | P1 | Verify async transaction rollback works | Validates async error handling | TECH-001 |
| 1.3-INT-011 | Integration | P2 | Verify async operations handle connection errors gracefully | Validates error handling | TECH-001, OPS-002 |

**Coverage**: Comprehensive async configuration testing from dependency verification through async operations and error handling.

---

### AC3: Database connection pooling is configured

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-UNIT-003 | Unit | P1 | Verify connection pool configuration (pool_size, max_overflow) | Validates configuration logic | TECH-003 |
| 1.3-INT-012 | Integration | P0 | Verify connection pool is created with correct size | Validates pool initialization | TECH-003 |
| 1.3-INT-013 | Integration | P0 | Verify connection pool handles concurrent requests | Validates pool under load | TECH-003, PERF-001 |
| 1.3-INT-014 | Integration | P1 | Verify connection pool overflow works when pool exhausted | Validates burst capacity | TECH-003 |
| 1.3-INT-015 | Integration | P1 | Verify connection pool metrics are accessible | Validates monitoring capability | TECH-003 |
| 1.3-INT-016 | Integration | P2 | Verify connection pool recovery after connection failure | Validates resilience | TECH-003, OPS-002 |
| 1.3-INT-017 | Integration | P2 | Verify connection timeout configuration works | Validates timeout handling | TECH-003 |

**Coverage**: Connection pooling tested from configuration through load scenarios, monitoring, and recovery.

---

### AC4: Alembic is set up for database migrations

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-UNIT-004 | Unit | P0 | Verify Alembic is installed | Validates dependency | TECH-002 |
| 1.3-INT-018 | Integration | P0 | Verify Alembic is initialized in backend/alembic/ | Validates Alembic setup | TECH-002 |
| 1.3-INT-019 | Integration | P0 | Verify alembic/env.py uses AsyncEngine | Validates async Alembic config | TECH-002 |
| 1.3-INT-020 | Integration | P0 | Verify Alembic reads DATABASE_URL from environment | Validates environment configuration | TECH-002, SEC-001 |
| 1.3-INT-021 | Integration | P1 | Verify Alembic can generate migration scripts | Validates migration generation | TECH-002 |
| 1.3-INT-022 | Integration | P1 | Verify Alembic can detect model changes | Validates auto-generation | TECH-002, TECH-005 |
| 1.3-INT-023 | Integration | P2 | Verify Alembic configuration is documented | Validates documentation | OPS-004 |

**Coverage**: Alembic setup tested from installation through configuration, migration generation, and documentation.

---

### AC5: Initial migration creates base schema structure

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-INT-024 | Integration | P0 | Verify initial migration creates UUID extension | Validates extension setup | TECH-006 |
| 1.3-INT-025 | Integration | P0 | Verify initial migration creates users table | Validates table creation | TECH-005 |
| 1.3-INT-026 | Integration | P0 | Verify initial migration creates documents table | Validates table creation | TECH-005 |
| 1.3-INT-027 | Integration | P0 | Verify initial migration creates translations table | Validates table creation | TECH-005 |
| 1.3-INT-028 | Integration | P0 | Verify initial migration creates all indexes | Validates index creation | PERF-002 |
| 1.3-INT-029 | Integration | P0 | Verify initial migration creates trigger function | Validates trigger setup | TECH-005 |
| 1.3-INT-030 | Integration | P0 | Verify initial migration creates triggers on all tables | Validates trigger application | TECH-005 |
| 1.3-INT-031 | Integration | P0 | Verify initial migration creates all constraints | Validates constraint creation | TECH-005 |
| 1.3-INT-032 | Integration | P0 | Verify migration can be applied to test database | Validates migration execution | DATA-001, OPS-001 |
| 1.3-INT-033 | Integration | P0 | Verify migration can be rolled back | Validates rollback capability | DATA-001, TECH-004 |
| 1.3-INT-034 | Integration | P1 | Verify migration idempotency (can run twice) | Validates migration safety | DATA-001 |
| 1.3-INT-035 | Integration | P1 | Verify migration creates schema matching models | Validates model-schema alignment | TECH-005 |
| 1.3-INT-036 | Integration | P2 | Verify migration handles existing data correctly | Validates data preservation | DATA-003 |

**Coverage**: Comprehensive migration testing from schema creation through rollback, idempotency, and data preservation.

---

### AC6: Database connection can be established and tested

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-INT-037 | Integration | P0 | Verify database connection can be established | Validates basic connectivity | TECH-001, OPS-002 |
| 1.3-INT-038 | Integration | P0 | Verify get_db() dependency provides valid session | Validates dependency injection | TECH-001 |
| 1.3-INT-039 | Integration | P0 | Verify database session can execute queries | Validates query execution | TECH-001 |
| 1.3-INT-040 | Integration | P0 | Verify test database fixture creates/drops database | Validates test infrastructure | OPS-001 |
| 1.3-INT-041 | Integration | P0 | Verify test database session fixture works | Validates test session setup | OPS-001 |
| 1.3-INT-042 | Integration | P1 | Verify database connection retry logic works | Validates resilience | OPS-002 |
| 1.3-INT-043 | Integration | P1 | Verify database connection error handling | Validates error handling | OPS-002 |
| 1.3-INT-044 | Integration | P1 | Verify database connection timeout handling | Validates timeout behavior | OPS-002 |
| 1.3-INT-045 | Integration | P2 | Verify database connection metrics are logged | Validates observability | OPS-003 |
| 1.3-INT-060 | Integration | P0 | Verify connection errors do not expose credentials in logs | Validates error handling security | SEC-001 |
| 1.3-INT-061 | Integration | P1 | Verify connection errors provide appropriate detail without sensitive data | Validates error message security | SEC-001 |
| 1.3-E2E-002 | E2E | P0 | Verify database connection from application startup | Validates startup connectivity | TECH-001, OPS-002 |

**Coverage**: Database connection tested from basic establishment through dependency injection, test infrastructure, error handling, and startup.

---

### AC7: Environment variables for database configuration are properly managed

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-UNIT-005 | Unit | P0 | Verify DATABASE_URL is loaded from environment | Validates config loading | SEC-001 |
| 1.3-UNIT-006 | Unit | P0 | Verify DATABASE_URL is not logged | Validates credential security | SEC-001 |
| 1.3-UNIT-007 | Unit | P1 | Verify DATABASE_URL format validation | Validates connection string format | SEC-003 |
| 1.3-UNIT-008 | Unit | P1 | Verify missing DATABASE_URL raises clear error | Validates error handling | OPS-002 |
| 1.3-INT-046 | Integration | P0 | Verify .env.example contains DATABASE_URL template | Validates documentation | OPS-004 |
| 1.3-INT-047 | Integration | P1 | Verify DATABASE_URL from .env file is loaded | Validates .env file loading | SEC-001 |
| 1.3-INT-048 | Integration | P1 | Verify DATABASE_URL from environment overrides .env | Validates precedence | SEC-001 |
| 1.3-INT-049 | Integration | P2 | Verify database configuration is documented | Validates documentation | OPS-004 |
| 1.3-INT-062 | Integration | P1 | Verify database user has only required permissions (least privilege) | Validates permission security | SEC-005 |
| 1.3-INT-063 | Integration | P2 | Verify database user cannot perform unauthorized operations | Validates permission restrictions | SEC-005 |
| 1.3-E2E-003 | E2E | P1 | Verify application starts with DATABASE_URL from environment | Validates production config | SEC-001 |

**Coverage**: Environment variable management tested from loading through security, validation, documentation, and production scenarios.

---

## Additional Test Scenarios

### Model Validation Tests

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-UNIT-009 | Unit | P0 | Verify User model matches schema definition | Validates model-schema alignment | TECH-005 |
| 1.3-UNIT-010 | Unit | P0 | Verify Document model matches schema definition | Validates model-schema alignment | TECH-005 |
| 1.3-UNIT-011 | Unit | P0 | Verify Translation model matches schema definition | Validates model-schema alignment | TECH-005 |
| 1.3-INT-050 | Integration | P0 | Verify User model can be created and queried | Validates model operations | TECH-005 |
| 1.3-INT-051 | Integration | P0 | Verify Document model can be created and queried | Validates model operations | TECH-005 |
| 1.3-INT-052 | Integration | P0 | Verify Translation model can be created and queried | Validates model operations | TECH-005 |
| 1.3-INT-053 | Integration | P1 | Verify model relationships work correctly | Validates foreign keys | TECH-005 |
| 1.3-INT-054 | Integration | P1 | Verify model constraints are enforced | Validates check constraints | TECH-005 |
| 1.3-INT-055 | Integration | P1 | Verify model indexes are created | Validates index creation | PERF-002 |
| 1.3-INT-056 | Integration | P2 | Verify model UUID generation works | Validates UUID defaults | DATA-004 |

**Coverage**: Model validation tested from schema alignment through operations, relationships, constraints, and UUID generation.

### Security Tests

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-UNIT-012 | Unit | P0 | Verify SQLAlchemy ORM is used (no raw SQL with string formatting) | Validates SQL injection protection | SEC-002 |
| 1.3-INT-064 | Integration | P0 | Verify all database queries use parameterized queries | Validates SQL injection protection | SEC-002 |
| 1.3-INT-065 | Integration | P1 | Verify connection string validation prevents injection | Validates connection string security | SEC-003 |

**Coverage**: Security testing covers SQL injection protection, connection string security, and ORM usage validation.

### Full-Stack Integration Test

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|----------------|
| 1.3-E2E-004 | E2E | P1 | Verify database operations work in containerized environment | Validates Docker integration | TECH-001, OPS-002 |

**Coverage**: Full-stack validation of database operations in containerized environment.

---

## Risk Coverage

### High-Risk Mitigation (Score 6)

**TECH-001: SQLAlchemy 2.0 Async Compatibility**
- Covered by: 1.3-INT-005 through 1.3-INT-011, 1.3-INT-037 through 1.3-INT-039, 1.3-E2E-001, 1.3-E2E-002
- Test focus: Async engine creation, async session operations, async transactions, connection establishment

**TECH-003: Connection Pooling Misconfiguration**
- Covered by: 1.3-INT-012 through 1.3-INT-017, 1.3-INT-008
- Test focus: Pool configuration, concurrent requests, overflow, recovery, monitoring

**SEC-001: Database Credentials Exposure**
- Covered by: 1.3-UNIT-005, 1.3-UNIT-006, 1.3-INT-020, 1.3-INT-046 through 1.3-INT-048, 1.3-INT-060, 1.3-INT-061, 1.3-E2E-003
- Test focus: Credential loading, logging prevention, environment variable handling, error message security

**SEC-004: SSL/TLS Not Enforced in Production**
- Covered by: 1.3-INT-057, 1.3-INT-058, 1.3-INT-059
- Test focus: SSL connection establishment, certificate validation, SSL enforcement

**DATA-002: Missing Backup Strategy**
- Note: Backup strategy is operational/documentation concern, not directly testable in this story. Covered by documentation tests (1.3-INT-023, 1.3-INT-049).

### Medium-Risk Mitigation (Score 4)

**TECH-002: Alembic Async Configuration**
- Covered by: 1.3-INT-018 through 1.3-INT-022
- Test focus: Alembic initialization, async engine configuration, migration generation

**TECH-005: Model-Schema Mismatch**
- Covered by: 1.3-UNIT-009 through 1.3-UNIT-011, 1.3-INT-025 through 1.3-INT-031, 1.3-INT-035, 1.3-INT-050 through 1.3-INT-055
- Test focus: Model-schema alignment, table creation, constraint validation

**PERF-001: Connection Pool Sizing**
- Covered by: 1.3-INT-012, 1.3-INT-013, 1.3-INT-014
- Test focus: Pool configuration, concurrent load handling

**OPS-001: Migration Testing**
- Covered by: 1.3-INT-032, 1.3-INT-033, 1.3-INT-040, 1.3-INT-041
- Test focus: Migration execution, rollback, test database setup

**OPS-002: Connection Failure Handling**
- Covered by: 1.3-INT-002, 1.3-INT-011, 1.3-INT-016, 1.3-INT-042 through 1.3-INT-044, 1.3-INT-060, 1.3-INT-061, 1.3-E2E-001, 1.3-E2E-002
- Test focus: Error handling, retry logic, timeout handling, graceful degradation, credential protection in errors

### Low-Risk Mitigation (Score 2-3)

**SEC-002: SQL Injection if Raw SQL Used**
- Covered by: 1.3-UNIT-012, 1.3-INT-064
- Test focus: ORM usage verification, parameterized query validation

**SEC-003: Connection String Injection**
- Covered by: 1.3-INT-065, 1.3-UNIT-007
- Test focus: Connection string validation, format checking

**SEC-005: Database User Permissions Too Permissive**
- Covered by: 1.3-INT-062, 1.3-INT-063
- Test focus: Permission verification, least privilege validation

---

## Recommended Execution Order

### Phase 1: P0 Unit Tests (Fail Fast)
1. 1.3-UNIT-001: SQLAlchemy 2.0 version check
2. 1.3-UNIT-002: asyncpg driver check
3. 1.3-UNIT-004: Alembic installation check
4. 1.3-UNIT-005: DATABASE_URL loading
5. 1.3-UNIT-006: DATABASE_URL logging prevention
6. 1.3-UNIT-009 through 1.3-UNIT-011: Model schema alignment
7. 1.3-UNIT-012: SQLAlchemy ORM usage verification

### Phase 2: P0 Integration Tests (Core Functionality)
7. 1.3-INT-001: PostgreSQL service startup
8. 1.3-INT-002: Database connection from container
9. 1.3-INT-005: AsyncEngine creation
10. 1.3-INT-006: AsyncSession creation
11. 1.3-INT-007: Async query execution
12. 1.3-INT-008: Session cleanup
13. 1.3-INT-012: Connection pool creation
14. 1.3-INT-013: Connection pool concurrent requests
15. 1.3-INT-018: Alembic initialization
16. 1.3-INT-019: Alembic async config
17. 1.3-INT-020: Alembic environment reading
18. 1.3-INT-024 through 1.3-INT-031: Migration schema creation
19. 1.3-INT-032: Migration application
20. 1.3-INT-033: Migration rollback
21. 1.3-INT-037: Database connection establishment
22. 1.3-INT-038: get_db() dependency
23. 1.3-INT-039: Query execution
24. 1.3-INT-040: Test database fixture
25. 1.3-INT-041: Test session fixture
26. 1.3-INT-046: .env.example template
27. 1.3-INT-050 through 1.3-INT-052: Model CRUD operations
28. 1.3-INT-057: SSL/TLS enforcement in production
29. 1.3-INT-058: SSL certificate validation
30. 1.3-INT-060: Connection errors do not expose credentials
31. 1.3-INT-064: All queries use parameterized queries

### Phase 3: P0 E2E Tests (Critical Paths)
28. 1.3-E2E-001: Full stack database connection
29. 1.3-E2E-002: Database connection from startup

### Phase 4: P1 Tests (Core Features)
30. All remaining P1 tests in order (1.3-INT-003, 1.3-INT-004, 1.3-INT-009, etc.)

### Phase 5: P2 Tests (Edge Cases)
31. All P2 tests as time permits

---

## Test Coverage Summary

### By Acceptance Criterion

| AC | Unit Tests | Integration Tests | E2E Tests | Total | Coverage |
|----|------------|-------------------|----------|-------|----------|
| AC1 | 0 | 4 | 1 | 5 | Complete |
| AC2 | 2 | 7 | 0 | 9 | Complete |
| AC3 | 1 | 6 | 0 | 7 | Complete |
| AC4 | 1 | 6 | 0 | 7 | Complete |
| AC5 | 0 | 13 | 0 | 13 | Complete |
| AC6 | 0 | 9 | 1 | 10 | Complete |
| AC7 | 4 | 4 | 1 | 9 | Complete |
| Additional | 5 | 9 | 1 | 15 | Complete |
| **Total** | **13** | **49** | **4** | **66** | **100%** |

### By Priority

| Priority | Count | Percentage |
|----------|-------|------------|
| P0 | 28 | 42% |
| P1 | 24 | 36% |
| P2 | 14 | 21% |

### By Test Level

| Level | Count | Percentage |
|-------|-------|------------|
| Unit | 13 | 20% |
| Integration | 49 | 74% |
| E2E | 4 | 6% |

---

## Test Infrastructure Requirements

### Test Database Setup

**Location**: `backend/tests/conftest.py`

**Required Fixtures**:
- `test_db`: Creates/drops test database
- `db_session`: Provides test database session
- `apply_migrations`: Applies Alembic migrations to test database

**Test Database Configuration**:
- Database name: `librilabs_translator_test`
- Separate from development database
- Migrations applied before each test suite
- Database dropped after test suite completion

### Test Dependencies

**Required Packages**:
- `pytest`: Test framework
- `pytest-asyncio`: Async test support
- `httpx`: HTTP client for API testing (if needed)
- `sqlalchemy`: Database ORM (already in requirements)

### Test Environment Variables

**Required Environment Variables for Tests**:
- `TEST_DATABASE_URL`: Test database connection string
- `DATABASE_URL`: Development database (for comparison tests)

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention (`1.3-{LEVEL}-{SEQ}`)
- [x] Scenarios are atomic and independent
- [x] High-risk areas have comprehensive test coverage
- [x] Test execution order is optimized (fail fast)

---

**Test Design Generated**: 2025-01-27
**Updated**: 2025-01-27 (v1.1 - Added security test scenarios for SSL/TLS enforcement, credential protection, SQL injection protection, and database user permissions)
**Next Review**: After implementation completion or if requirements change

