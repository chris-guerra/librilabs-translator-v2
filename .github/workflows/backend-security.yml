name: Backend Security Checks

on:
  push:
    branches: [main, development]
    paths:
      - 'backend/**'
  pull_request:
    branches: [main, development]
    paths:
      - 'backend/**'

jobs:
  security-validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx
      
      - name: Run security validation script
        working-directory: ./backend
        run: |
          chmod +x scripts/validate-security.sh
          ./scripts/validate-security.sh
      
      - name: Run security tests
        working-directory: ./backend
        run: |
          pytest tests/integration/test_routers/test_cors.py \
                 tests/integration/test_routers/test_cors_production.py \
                 tests/integration/test_routers/test_error_handling.py \
                 tests/unit/test_config.py \
                 -v
      
      - name: Check for secrets with detect-secrets
        working-directory: ./backend
        run: |
          pip install detect-secrets
          if [ -f .secrets.baseline ]; then
            detect-secrets audit .secrets.baseline
          else
            echo "⚠️ Warning: .secrets.baseline not found"
          fi
      
      - name: Verify no API keys in code
        working-directory: ./backend
        run: |
          if grep -r "sk-[a-zA-Z0-9]\{20,\}" app/ --exclude-dir=__pycache__ 2>/dev/null; then
            echo "❌ ERROR: Potential API keys found in source code"
            exit 1
          else
            echo "✅ No hardcoded API keys found"
          fi
